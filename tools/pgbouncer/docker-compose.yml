version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: veritas-postgres
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 20

  pgbouncer:
    image: bitnami/pgbouncer:latest
    container_name: veritas-pgbouncer
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "6432:6432"
    environment:
      # Map PostgreSQL target and pooling options via .env.pgbouncer
      - PGBOUNCER_DATABASES=veritas=host=${POSTGRES_HOST} port=${POSTGRES_PORT} dbname=${POSTGRES_DB} user=${POSTGRES_USER} password=${POSTGRES_PASSWORD}
      - PGBOUNCER_POOL_MODE=${PGBOUNCER_POOL_MODE}
      - PGBOUNCER_MAX_CLIENT_CONN=${PGBOUNCER_MAX_CLIENT_CONN}
      - PGBOUNCER_DEFAULT_POOL_SIZE=${PGBOUNCER_DEFAULT_POOL_SIZE}
      - PGBOUNCER_IGNORE_STARTUP_PARAMETERS=extra_float_digits
    env_file:
      - .env.pgbouncer
    restart: unless-stopped
