"""
VERITAS API v3 - Phase 2 Integration Test

Testet die Domain-spezifischen Router: VPB, COVINA, PKI, IMMI
"""

import os
import sys

# Add backend to path
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "..", "..")))


def test_domain_router_imports():
    """Teste Domain Router Imports"""
    print("üîß Teste API v3 Domain Router Imports...")

    try:
        # VPB Router
        from backend.api.v3.vpb_router import vpb_router

        print("‚úÖ VPB Router importiert")

        # COVINA Router
        from backend.api.v3.covina_router import covina_router

        print("‚úÖ COVINA Router importiert")

        # PKI Router
        from backend.api.v3.pki_router import pki_router

        print("‚úÖ PKI Router importiert")

        # IMMI Router
        from backend.api.v3.immi_router import immi_router

        print("‚úÖ IMMI Router importiert")

        return True

    except Exception as e:
        print(f"‚ùå Import-Fehler: {e}")
        import traceback

        traceback.print_exc()
        return False


def test_domain_models():
    """Teste Domain-spezifische Pydantic Models"""
    print("\nüîß Teste Domain Models...")

    try:
        from backend.api.v3.models import (  # VPB Models; COVINA Models; PKI Models; IMMI Models
            COVINAQueryRequest,
            COVINAQueryResponse,
            COVINAReport,
            COVINAStatistics,
            IMMIGeoData,
            IMMIQueryRequest,
            IMMIQueryResponse,
            IMMIRegulation,
            PKICertificate,
            PKIQueryRequest,
            PKIQueryResponse,
            PKIValidationRequest,
            PKIValidationResponse,
            VPBAnalysisRequest,
            VPBAnalysisResponse,
            VPBDocument,
            VPBQueryRequest,
            VPBQueryResponse,
        )

        print("‚úÖ Alle Domain Models importiert")

        # Test VPB Model Instanziierung
        vpb_req = VPBQueryRequest(query="Test VPB Query", mode="veritas")
        print(f"  ‚úÖ VPBQueryRequest: {vpb_req.query}")

        # Test COVINA Model Instanziierung
        covina_stat = COVINAStatistics(region="Deutschland", date="2025-10-17", cases=1000, incidence=50.5, r_value=0.95)
        print(f"  ‚úÖ COVINAStatistics: {covina_stat.region}, Incidence={covina_stat.incidence}")

        # Test PKI Model Instanziierung
        pki_cert = PKICertificate(
            certificate_id="test_001",
            subject="CN=test.com",
            issuer="CN=Test CA",
            valid_from="2025-01-01",
            valid_until="2026-01-01",
            status="valid",
        )
        print(f"  ‚úÖ PKICertificate: {pki_cert.subject}, Status={pki_cert.status}")

        # Test IMMI Model Instanziierung
        immi_geo = IMMIGeoData(location_id="wka_001", latitude=52.5200, longitude=13.4050, type="wka")
        print(f"  ‚úÖ IMMIGeoData: {immi_geo.location_id}, Type={immi_geo.type}")

        return True

    except Exception as e:
        print(f"‚ùå Model-Fehler: {e}")
        import traceback

        traceback.print_exc()
        return False


def test_router_structure():
    """Teste Router Struktur"""
    print("\nüîß Teste Router Struktur...")

    try:
        from backend.api.v3.covina_router import covina_router
        from backend.api.v3.immi_router import immi_router
        from backend.api.v3.pki_router import pki_router
        from backend.api.v3.vpb_router import vpb_router

        # Check Router Prefixes
        print(f"  ‚úÖ VPB Router Prefix: {vpb_router.prefix}")
        print(f"  ‚úÖ COVINA Router Prefix: {covina_router.prefix}")
        print(f"  ‚úÖ PKI Router Prefix: {pki_router.prefix}")
        print(f"  ‚úÖ IMMI Router Prefix: {immi_router.prefix}")

        # Count Routes
        vpb_routes = len(vpb_router.routes)
        covina_routes = len(covina_router.routes)
        pki_routes = len(pki_router.routes)
        immi_routes = len(immi_router.routes)

        print(f"\n  üìä Route Count:")
        print(f"    VPB: {vpb_routes} routes")
        print(f"    COVINA: {covina_routes} routes")
        print(f"    PKI: {pki_routes} routes")
        print(f"    IMMI: {immi_routes} routes")
        print(f"    Total: {vpb_routes + covina_routes + pki_routes + immi_routes} routes")

        return True

    except Exception as e:
        print(f"‚ùå Router Struktur Fehler: {e}")
        import traceback

        traceback.print_exc()
        return False


def main():
    """Main Test Function"""
    print("=" * 60)
    print("VERITAS API v3 - Phase 2 Domain Endpoints Integration Test")
    print("=" * 60)

    results = []

    # Test 1: Router Imports
    results.append(("Router Imports", test_domain_router_imports()))

    # Test 2: Domain Models
    results.append(("Domain Models", test_domain_models()))

    # Test 3: Router Structure
    results.append(("Router Structure", test_router_structure()))

    # Summary
    print("\n" + "=" * 60)
    print("üìä Test Summary:")
    print("=" * 60)

    for test_name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"{status}: {test_name}")

    all_passed = all(result for _, result in results)

    if all_passed:
        print("\nüéâ Alle Tests erfolgreich - Phase 2 Domain Endpoints bereit!")
        return 0
    else:
        print("\n‚ùå Einige Tests fehlgeschlagen - Bitte Fehler beheben")
        return 1


if __name__ == "__main__":
    sys.exit(main())
