"""
Rich Media JSON Schema fÃ¼r VERITAS Antworten
=============================================

Erweitert das JSON-Schema um Rich Media Support:
- ğŸ–¼ï¸ Images (URLs, Base64, Captions)
- ğŸ—ºï¸ Maps (GeoJSON, Marker, Bounds)
- ğŸ“Š Charts (Plotly JSON, Chart.js config)
- ğŸ¥ Videos (YouTube, Vimeo, Local)
- ğŸ“„ Documents (PDFs, Downloads)
- ğŸ“‹ Tables (Structured Data)
"""

import json
from dataclasses import dataclass
from typing import Any, Dict, List, Literal, Optional

# ============================================================================
# RICH MEDIA TYPES
# ============================================================================


@dataclass
class ImageMedia:
    """Image embedding"""

    url: str
    caption: Optional[str] = None
    alt_text: Optional[str] = None
    width: Optional[int] = None
    height: Optional[int] = None
    source: Optional[str] = None  # Citation source


@dataclass
class GeoMapMedia:
    """Geographic map with markers"""

    center: tuple[float, float]  # (lat, lon)
    zoom: int = 12
    markers: List[Dict[str, Any]] = None  # [{"lat": 52.5, "lon": 13.4, "label": "Berlin"}]
    geojson: Optional[Dict] = None  # Full GeoJSON object
    bounds: Optional[List[List[float]]] = None  # [[lat_min, lon_min], [lat_max, lon_max]]


@dataclass
class ChartMedia:
    """Data visualization chart"""

    chart_type: Literal["bar", "line", "pie", "scatter", "heatmap"]
    data: Dict[str, Any]  # Chart.js or Plotly JSON format
    title: Optional[str] = None
    description: Optional[str] = None


@dataclass
class VideoMedia:
    """Video embedding"""

    url: str
    platform: Literal["youtube", "vimeo", "local"]
    title: Optional[str] = None
    thumbnail: Optional[str] = None
    duration: Optional[int] = None  # seconds


@dataclass
class DocumentMedia:
    """Document download/preview"""

    url: str
    filename: str
    file_type: Literal["pdf", "docx", "xlsx", "txt", "csv"]
    size: Optional[int] = None  # bytes
    description: Optional[str] = None


@dataclass
class TableMedia:
    """Structured data table"""

    headers: List[str]
    rows: List[List[Any]]
    caption: Optional[str] = None
    footer: Optional[str] = None


# ============================================================================
# ENHANCED JSON SCHEMA
# ============================================================================

RICH_MEDIA_SCHEMA = {
    "type": "object",
    "required": ["direct_answer", "details", "citations", "sources"],
    "properties": {
        "direct_answer": {"type": "string", "description": "Kurze, direkte Antwort (2-3 SÃ¤tze)"},
        "details": {"type": "array", "items": {"type": "string"}, "description": "Detail-Punkte mit Fakten"},
        "citations": {
            "type": "array",
            "items": {"type": "object", "properties": {"text": {"type": "string"}, "source_id": {"type": "integer"}}},
            "description": "Text-Fragment â†’ Quellen-ID Zuordnung",
        },
        "sources": {"type": "array", "items": {"type": "string"}, "description": "Verwendete Quellen (nummeriert)"},
        # Rich Media Extensions
        "images": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "url": {"type": "string"},
                    "caption": {"type": "string"},
                    "alt_text": {"type": "string"},
                    "source_id": {"type": "integer"},
                },
            },
            "description": "ğŸ–¼ï¸ Eingebettete Bilder",
        },
        "maps": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "center": {"type": "array", "items": {"type": "number"}},
                    "zoom": {"type": "integer"},
                    "markers": {"type": "array"},
                    "geojson": {"type": "object"},
                },
            },
            "description": "ğŸ—ºï¸ Geografische Karten",
        },
        "charts": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "chart_type": {"type": "string", "enum": ["bar", "line", "pie", "scatter"]},
                    "data": {"type": "object"},
                    "title": {"type": "string"},
                },
            },
            "description": "ğŸ“Š Datenvisualisierungen",
        },
        "videos": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "url": {"type": "string"},
                    "platform": {"type": "string", "enum": ["youtube", "vimeo", "local"]},
                    "title": {"type": "string"},
                },
            },
            "description": "ğŸ¥ Video-Einbettungen",
        },
        "documents": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {"url": {"type": "string"}, "filename": {"type": "string"}, "file_type": {"type": "string"}},
            },
            "description": "ğŸ“„ Dokumente zum Download",
        },
        "tables": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "headers": {"type": "array", "items": {"type": "string"}},
                    "rows": {"type": "array"},
                    "caption": {"type": "string"},
                },
            },
            "description": "ğŸ“‹ Strukturierte Tabellen",
        },
        "next_steps": {"type": "string", "description": "Was sollte User als nÃ¤chstes tun?"},
        "follow_ups": {"type": "array", "items": {"type": "string"}, "description": "3-5 Follow-up Fragen"},
    },
}


# ============================================================================
# RICH MEDIA PROMPT TEMPLATES
# ============================================================================


def get_rich_media_prompt() -> Dict[str, str]:
    """
    Returns enhanced JSON prompt with Rich Media support
    """
    return {
        "system": """Du bist ein intelligenter Assistent fÃ¼r Verwaltungsfragen mit Rich Media Support.

AUSGABEFORMAT: **NUR VALID JSON** (kein zusÃ¤tzlicher Text!)

Deine Antwort MUSS diesem JSON-Schema folgen:

{
  "direct_answer": "Kurze direkte Antwort (2-3 SÃ¤tze)",
  "details": ["Detail 1", "Detail 2", "Detail 3"],
  "citations": [
    {"text": "Zu zitierender Fakt", "source_id": 1}
  ],
  "sources": ["Quelle 1", "Quelle 2"],

  // OPTIONAL: Rich Media
  "images": [
    {
      "url": "https://example.com/image.jpg",
      "caption": "Beschreibung",
      "alt_text": "Alt-Text",
      "source_id": 1
    }
  ],
  "maps": [
    {
      "center": [52.5200, 13.4050],
      "zoom": 12,
      "markers": [
        {"lat": 52.5200, "lon": 13.4050, "label": "Berlin", "popup": "Hauptstadt"}
      ]
    }
  ],
  "charts": [
    {
      "chart_type": "bar",
      "data": {
        "labels": ["Jan", "Feb", "MÃ¤r"],
        "datasets": [{
          "label": "BauantrÃ¤ge",
          "data": [12, 19, 15]
        }]
      },
      "title": "BauantrÃ¤ge 2024"
    }
  ],
  "tables": [
    {
      "headers": ["Kommune", "GebÃ¼hr", "Bearbeitungszeit"],
      "rows": [
        ["Berlin", "250â‚¬", "6 Wochen"],
        ["MÃ¼nchen", "300â‚¬", "8 Wochen"]
      ],
      "caption": "Vergleich BaugenehmigungsgebÃ¼hren"
    }
  ],
  "videos": [...],  // Optional
  "documents": [...],  // Optional

  "next_steps": "Was sollte User als nÃ¤chstes tun?",
  "follow_ups": ["Frage 1?", "Frage 2?", "Frage 3?"]
}

WICHTIG:
- JEDER Fakt muss in "citations" referenziert werden
- Rich Media NUR wenn sinnvoll (nicht erzwingen!)
- Antworte NUR mit valid JSON (keine ErklÃ¤rungen davor/danach!)

WANN Rich Media nutzen:
ğŸ–¼ï¸ Images: Bei GebÃ¤uden, PlÃ¤nen, Formularen
ğŸ—ºï¸ Maps: Bei Standorten, ZustÃ¤ndigkeitsgebieten, Verkehrsfragen
ğŸ“Š Charts: Bei Statistiken, Vergleichen, Trends
ğŸ“‹ Tables: Bei GebÃ¼hren-Vergleichen, Fristen-Ãœbersichten
ğŸ¥ Videos: Bei Tutorials, ErklÃ¤rvideos
ğŸ“„ Documents: Bei Formularen, MerkblÃ¤ttern, PDFs
""",
        "user_template": """**User fragte:** {query}

**VerfÃ¼gbare Quellen:**
{source_list}

**Kontext aus Dokumenten:**
{rag_context}

**Agent-Erkenntnisse:**
{agent_results}

**BEISPIEL 1 (Baukosten mit Tabelle):**

Frage: "Welche Kosten entstehen bei einer Baugenehmigung?"

{{
  "direct_answer": "Die Kosten fÃ¼r eine Baugenehmigung variieren je nach Kommune und liegen zwischen 150â‚¬ und 500â‚¬ GrundgebÃ¼hr plus 0,5% der Bausumme.",
  "details": [
    "GrundgebÃ¼hr richtet sich nach Gemeinde und Bauvorhaben",
    "GrÃ¶ÃŸenabhÃ¤ngige GebÃ¼hr betrÃ¤gt 0,5% der Bausumme",
    "ZusÃ¤tzliche PrÃ¼fungsgebÃ¼hren fÃ¼r Statik: 200-800â‚¬",
    "Beispiel: Einfamilienhaus (300.000â‚¬) = ca. 1.800â‚¬ Gesamtkosten"
  ],
  "citations": [
    {{"text": "GrundgebÃ¼hr richtet sich nach Gemeinde", "source_id": 1}},
    {{"text": "0,5% der Bausumme", "source_id": 1}},
    {{"text": "PrÃ¼fungsgebÃ¼hren fÃ¼r Statik: 200-800â‚¬", "source_id": 2}}
  ],
  "sources": [
    "GebÃ¼hrenordnung BauO BW",
    "Kostenrechner Stadt Stuttgart"
  ],
  "tables": [
    {{
      "headers": ["Kommune", "GrundgebÃ¼hr", "GrÃ¶ÃŸengebÃ¼hr", "Beispiel (300kâ‚¬)"],
      "rows": [
        ["Berlin", "250â‚¬", "0.5%", "1.750â‚¬"],
        ["MÃ¼nchen", "350â‚¬", "0.5%", "1.850â‚¬"],
        ["Stuttgart", "200â‚¬", "0.5%", "1.700â‚¬"]
      ],
      "caption": "Vergleich Baugenehmigungskosten (Stand 2024)"
    }}
  ],
  "next_steps": "Kontaktieren Sie Ihr zustÃ¤ndiges Bauordnungsamt fÃ¼r eine genaue KostenschÃ¤tzung.",
  "follow_ups": [
    "Wann werden die GebÃ¼hren fÃ¤llig?",
    "Kann ich die Kosten steuerlich absetzen?",
    "Gibt es ErmÃ¤ÃŸigungen fÃ¼r Sanierungen?"
  ]
}}

**BEISPIEL 2 (LuftqualitÃ¤t mit Karte + Chart):**

Frage: "Wie ist die LuftqualitÃ¤t in Berlin?"

{{
  "direct_answer": "Die LuftqualitÃ¤t in Berlin ist aktuell gut. Die Messwerte liegen unter den EU-Grenzwerten.",
  "details": [
    "Feinstaub (PM10): 18 Î¼g/mÂ³ (Grenzwert: 40 Î¼g/mÂ³)",
    "Stickstoffdioxid (NOâ‚‚): 22 Î¼g/mÂ³ (Grenzwert: 40 Î¼g/mÂ³)",
    "Ozon (Oâ‚ƒ): 45 Î¼g/mÂ³ (Zielwert: 120 Î¼g/mÂ³)",
    "Messungen vom Berliner LuftgÃ¼temessnetz"
  ],
  "citations": [
    {{"text": "Feinstaub (PM10): 18 Î¼g/mÂ³", "source_id": 1}},
    {{"text": "Stickstoffdioxid (NOâ‚‚): 22 Î¼g/mÂ³", "source_id": 1}},
    {{"text": "EU-Grenzwerte", "source_id": 2}}
  ],
  "sources": [
    "Berliner LuftgÃ¼temessnetz - Messdaten 10.10.2024",
    "EU-LuftqualitÃ¤tsrichtlinie 2008/50/EG"
  ],
  "maps": [
    {{
      "center": [52.5200, 13.4050],
      "zoom": 11,
      "markers": [
        {{"lat": 52.5200, "lon": 13.4050, "label": "Alexanderplatz", "popup": "PM10: 18 Î¼g/mÂ³"}},
        {{"lat": 52.5065, "lon": 13.2846, "label": "Charlottenburg", "popup": "PM10: 15 Î¼g/mÂ³"}},
        {{"lat": 52.4545, "lon": 13.5265, "label": "NeukÃ¶lln", "popup": "PM10: 22 Î¼g/mÂ³"}}
      ]
    }}
  ],
  "charts": [
    {{
      "chart_type": "bar",
      "data": {{
        "labels": ["PM10", "NOâ‚‚", "Oâ‚ƒ"],
        "datasets": [
          {{
            "label": "Aktuell (Î¼g/mÂ³)",
            "data": [18, 22, 45],
            "backgroundColor": "rgba(75, 192, 192, 0.6)"
          }},
          {{
            "label": "Grenzwert (Î¼g/mÂ³)",
            "data": [40, 40, 120],
            "backgroundColor": "rgba(255, 99, 132, 0.6)"
          }}
        ]
      }},
      "title": "LuftqualitÃ¤t Berlin - Vergleich mit Grenzwerten"
    }}
  ],
  "follow_ups": [
    "Welche Messstationen gibt es in meiner NÃ¤he?",
    "Wie hat sich die LuftqualitÃ¤t in den letzten Jahren entwickelt?",
    "Was kann ich persÃ¶nlich fÃ¼r bessere Luft tun?"
  ]
}}

**BEISPIEL 3 (Bauantrag mit Image + Document):**

Frage: "Welche Unterlagen brauche ich fÃ¼r einen Bauantrag?"

{{
  "direct_answer": "FÃ¼r einen Bauantrag benÃ¶tigen Sie das amtliche Formular, Bauzeichnungen, Lageplan und statische Berechnungen.",
  "details": [
    "Amtlicher Bauantrag (Formular Ihrer Kommune)",
    "Lageplan mit GrundstÃ¼cksgrenzen (M 1:500)",
    "Bauzeichnungen (Grundrisse, Schnitte, Ansichten)",
    "Statische Berechnungen von qualifiziertem Ingenieur",
    "Baubeschreibung mit Materialangaben"
  ],
  "citations": [
    {{"text": "Amtlicher Bauantrag", "source_id": 1}},
    {{"text": "Lageplan mit GrundstÃ¼cksgrenzen", "source_id": 1}},
    {{"text": "Statische Berechnungen von qualifiziertem Ingenieur", "source_id": 2}}
  ],
  "sources": [
    "Bauordnungsamt Brandenburg - Checkliste Bauantrag",
    "LBO BW Â§ 58 - Erforderliche Unterlagen"
  ],
  "images": [
    {{
      "url": "/media/bauantrag_beispiel_grundriss.png",
      "caption": "Beispiel: Grundriss fÃ¼r Bauantrag (Einfamilienhaus)",
      "alt_text": "Technische Zeichnung Grundriss Erdgeschoss",
      "source_id": 1
    }}
  ],
  "documents": [
    {{
      "url": "/downloads/bauantrag_formular_brandenburg.pdf",
      "filename": "Bauantrag-Formular-Brandenburg.pdf",
      "file_type": "pdf",
      "size": 245000,
      "description": "Amtliches Bauantragsformular Brandenburg (Stand 2024)"
    }},
    {{
      "url": "/downloads/checkliste_bauunterlagen.pdf",
      "filename": "Checkliste-Bauunterlagen.pdf",
      "file_type": "pdf",
      "description": "VollstÃ¤ndige Checkliste aller erforderlichen Unterlagen"
    }}
  ],
  "next_steps": "Laden Sie die Formulare herunter und wenden Sie sich fÃ¼r Beratung an Ihr zustÃ¤ndiges Bauordnungsamt.",
  "follow_ups": [
    "Wie lange dauert die Bearbeitung meines Bauantrags?",
    "Was kostet die Baugenehmigung?",
    "Kann ich den Bauantrag digital einreichen?"
  ]
}}

**Jetzt beantworte die User-Frage im GLEICHEN JSON-FORMAT (mit Rich Media wenn sinnvoll!):**
""",
    }


# ============================================================================
# FRONTEND RENDERER (Conceptual)
# ============================================================================


def render_rich_media_response(json_response: Dict[str, Any]) -> str:
    """
    Conceptual: Wie Frontend Rich Media rendern wÃ¼rde

    Returns:
        HTML/Markdown string with embedded rich media
    """
    output = []

    # Direct Answer
    output.append(f"**Direkte Antwort:**\n{json_response['direct_answer']}\n")

    # Details
    if json_response.get("details"):
        output.append("**Details:**\n")
        for detail in json_response["details"]:
            output.append(f"â€¢ {detail}")
        output.append("")

    # Images
    if json_response.get("images"):
        output.append("**ğŸ“¸ Bilder:**\n")
        for img in json_response["images"]:
            output.append(f"![{img.get('alt_text', 'Image')}]({img['url']})")
            if img.get("caption"):
                output.append(f"*{img['caption']}*")
        output.append("")

    # Maps
    if json_response.get("maps"):
        output.append("**ğŸ—ºï¸ Karte:**\n")
        for map_data in json_response["maps"]:
            output.append(f"<div class='map' data-center='{map_data['center']}' data-zoom='{map_data['zoom']}'></div>")
        output.append("")

    # Charts
    if json_response.get("charts"):
        output.append("**ğŸ“Š Diagramme:**\n")
        for chart in json_response["charts"]:
            output.append(
                f"<canvas id='chart-{chart.get('title', 'data')}' data-config='{json.dumps(chart['data'])}'></canvas>"
            )
        output.append("")

    # Tables
    if json_response.get("tables"):
        for table in json_response["tables"]:
            if table.get("caption"):
                output.append(f"**{table['caption']}**\n")

            # Markdown table
            output.append("| " + " | ".join(table["headers"]) + " |")
            output.append("| " + " | ".join(["---"] * len(table["headers"])) + " |")
            for row in table["rows"]:
                output.append("| " + " | ".join(str(cell) for cell in row) + " |")
            output.append("")

    # Sources
    if json_response.get("sources"):
        output.append("**Quellen:**")
        for i, source in enumerate(json_response["sources"], 1):
            output.append(f"[{i}] {source}")
        output.append("")

    # Follow-ups
    if json_response.get("follow_ups"):
        output.append("**ğŸ’¡ VorschlÃ¤ge:**")
        for q in json_response["follow_ups"]:
            output.append(f"â€¢ {q}")

    return "\n".join(output)


if __name__ == "__main__":
    print("=" * 80)
    print("ğŸ¨ RICH MEDIA JSON SCHEMA")
    print("=" * 80)
    print("\nSchema Preview:")
    print(json.dumps(RICH_MEDIA_SCHEMA, indent=2))

    print("\n" + "=" * 80)
    print("ğŸ“‹ Supported Media Types:")
    print("=" * 80)
    print("ğŸ–¼ï¸  Images - URLs, Captions, Alt-Text")
    print("ğŸ—ºï¸  Maps - GeoJSON, Markers, Interactive")
    print("ğŸ“Š Charts - Bar, Line, Pie, Scatter")
    print("ğŸ“‹ Tables - Structured Data with Headers")
    print("ğŸ¥ Videos - YouTube, Vimeo, Local")
    print("ğŸ“„ Documents - PDFs, Downloads, Previews")
