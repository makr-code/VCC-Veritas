"""
Rich Media JSON Schema f√ºr VERITAS Antworten
=============================================

Erweitert das JSON-Schema um Rich Media Support:
- üñºÔ∏è Images (URLs, Base64, Captions)
- üó∫Ô∏è Maps (GeoJSON, Marker, Bounds)
- üìä Charts (Plotly JSON, Chart.js config)
- üé• Videos (YouTube, Vimeo, Local)
- üìÑ Documents (PDFs, Downloads)
- üìã Tables (Structured Data)
"""

from typing import Dict, List, Any, Optional, Literal
from dataclasses import dataclass
import json


# ============================================================================
# RICH MEDIA TYPES
# ============================================================================

@dataclass
class ImageMedia:
    """Image embedding"""
    url: str
    caption: Optional[str] = None
    alt_text: Optional[str] = None
    width: Optional[int] = None
    height: Optional[int] = None
    source: Optional[str] = None  # Citation source


@dataclass
class GeoMapMedia:
    """Geographic map with markers"""
    center: tuple[float, float]  # (lat, lon)
    zoom: int = 12
    markers: List[Dict[str, Any]] = None  # [{"lat": 52.5, "lon": 13.4, "label": "Berlin"}]
    geojson: Optional[Dict] = None  # Full GeoJSON object
    bounds: Optional[List[List[float]]] = None  # [[lat_min, lon_min], [lat_max, lon_max]]


@dataclass
class ChartMedia:
    """Data visualization chart"""
    chart_type: Literal["bar", "line", "pie", "scatter", "heatmap"]
    data: Dict[str, Any]  # Chart.js or Plotly JSON format
    title: Optional[str] = None
    description: Optional[str] = None


@dataclass
class VideoMedia:
    """Video embedding"""
    url: str
    platform: Literal["youtube", "vimeo", "local"]
    title: Optional[str] = None
    thumbnail: Optional[str] = None
    duration: Optional[int] = None  # seconds


@dataclass
class DocumentMedia:
    """Document download/preview"""
    url: str
    filename: str
    file_type: Literal["pdf", "docx", "xlsx", "txt", "csv"]
    size: Optional[int] = None  # bytes
    description: Optional[str] = None


@dataclass
class TableMedia:
    """Structured data table"""
    headers: List[str]
    rows: List[List[Any]]
    caption: Optional[str] = None
    footer: Optional[str] = None


# ============================================================================
# ENHANCED JSON SCHEMA
# ============================================================================

RICH_MEDIA_SCHEMA = {
    "type": "object",
    "required": ["direct_answer", "details", "citations", "sources"],
    "properties": {
        "direct_answer": {
            "type": "string",
            "description": "Kurze, direkte Antwort (2-3 S√§tze)"
        },
        "details": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Detail-Punkte mit Fakten"
        },
        "citations": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "text": {"type": "string"},
                    "source_id": {"type": "integer"}
                }
            },
            "description": "Text-Fragment ‚Üí Quellen-ID Zuordnung"
        },
        "sources": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Verwendete Quellen (nummeriert)"
        },
        
        # Rich Media Extensions
        "images": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "url": {"type": "string"},
                    "caption": {"type": "string"},
                    "alt_text": {"type": "string"},
                    "source_id": {"type": "integer"}
                }
            },
            "description": "üñºÔ∏è Eingebettete Bilder"
        },
        "maps": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "center": {"type": "array", "items": {"type": "number"}},
                    "zoom": {"type": "integer"},
                    "markers": {"type": "array"},
                    "geojson": {"type": "object"}
                }
            },
            "description": "üó∫Ô∏è Geografische Karten"
        },
        "charts": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "chart_type": {"type": "string", "enum": ["bar", "line", "pie", "scatter"]},
                    "data": {"type": "object"},
                    "title": {"type": "string"}
                }
            },
            "description": "üìä Datenvisualisierungen"
        },
        "videos": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "url": {"type": "string"},
                    "platform": {"type": "string", "enum": ["youtube", "vimeo", "local"]},
                    "title": {"type": "string"}
                }
            },
            "description": "üé• Video-Einbettungen"
        },
        "documents": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "url": {"type": "string"},
                    "filename": {"type": "string"},
                    "file_type": {"type": "string"}
                }
            },
            "description": "üìÑ Dokumente zum Download"
        },
        "tables": {
            "type": "array",
            "items": {
                "type": "object",
                "properties": {
                    "headers": {"type": "array", "items": {"type": "string"}},
                    "rows": {"type": "array"},
                    "caption": {"type": "string"}
                }
            },
            "description": "üìã Strukturierte Tabellen"
        },
        
        "next_steps": {
            "type": "string",
            "description": "Was sollte User als n√§chstes tun?"
        },
        "follow_ups": {
            "type": "array",
            "items": {"type": "string"},
            "description": "3-5 Follow-up Fragen"
        }
    }
}


# ============================================================================
# RICH MEDIA PROMPT TEMPLATES
# ============================================================================

def get_rich_media_prompt() -> Dict[str, str]:
    """
    Returns enhanced JSON prompt with Rich Media support
    """
    return {
        "system": """Du bist ein intelligenter Assistent f√ºr Verwaltungsfragen mit Rich Media Support.

AUSGABEFORMAT: **NUR VALID JSON** (kein zus√§tzlicher Text!)

Deine Antwort MUSS diesem JSON-Schema folgen:

{
  "direct_answer": "Kurze direkte Antwort (2-3 S√§tze)",
  "details": ["Detail 1", "Detail 2", "Detail 3"],
  "citations": [
    {"text": "Zu zitierender Fakt", "source_id": 1}
  ],
  "sources": ["Quelle 1", "Quelle 2"],
  
  // OPTIONAL: Rich Media
  "images": [
    {
      "url": "https://example.com/image.jpg",
      "caption": "Beschreibung",
      "alt_text": "Alt-Text",
      "source_id": 1
    }
  ],
  "maps": [
    {
      "center": [52.5200, 13.4050],
      "zoom": 12,
      "markers": [
        {"lat": 52.5200, "lon": 13.4050, "label": "Berlin", "popup": "Hauptstadt"}
      ]
    }
  ],
  "charts": [
    {
      "chart_type": "bar",
      "data": {
        "labels": ["Jan", "Feb", "M√§r"],
        "datasets": [{
          "label": "Bauantr√§ge",
          "data": [12, 19, 15]
        }]
      },
      "title": "Bauantr√§ge 2024"
    }
  ],
  "tables": [
    {
      "headers": ["Kommune", "Geb√ºhr", "Bearbeitungszeit"],
      "rows": [
        ["Berlin", "250‚Ç¨", "6 Wochen"],
        ["M√ºnchen", "300‚Ç¨", "8 Wochen"]
      ],
      "caption": "Vergleich Baugenehmigungsgeb√ºhren"
    }
  ],
  "videos": [...],  // Optional
  "documents": [...],  // Optional
  
  "next_steps": "Was sollte User als n√§chstes tun?",
  "follow_ups": ["Frage 1?", "Frage 2?", "Frage 3?"]
}

WICHTIG:
- JEDER Fakt muss in "citations" referenziert werden
- Rich Media NUR wenn sinnvoll (nicht erzwingen!)
- Antworte NUR mit valid JSON (keine Erkl√§rungen davor/danach!)

WANN Rich Media nutzen:
üñºÔ∏è Images: Bei Geb√§uden, Pl√§nen, Formularen
üó∫Ô∏è Maps: Bei Standorten, Zust√§ndigkeitsgebieten, Verkehrsfragen
üìä Charts: Bei Statistiken, Vergleichen, Trends
üìã Tables: Bei Geb√ºhren-Vergleichen, Fristen-√úbersichten
üé• Videos: Bei Tutorials, Erkl√§rvideos
üìÑ Documents: Bei Formularen, Merkbl√§ttern, PDFs
""",

        "user_template": """**User fragte:** {query}

**Verf√ºgbare Quellen:**
{source_list}

**Kontext aus Dokumenten:**
{rag_context}

**Agent-Erkenntnisse:**
{agent_results}

**BEISPIEL 1 (Baukosten mit Tabelle):**

Frage: "Welche Kosten entstehen bei einer Baugenehmigung?"

{{
  "direct_answer": "Die Kosten f√ºr eine Baugenehmigung variieren je nach Kommune und liegen zwischen 150‚Ç¨ und 500‚Ç¨ Grundgeb√ºhr plus 0,5% der Bausumme.",
  "details": [
    "Grundgeb√ºhr richtet sich nach Gemeinde und Bauvorhaben",
    "Gr√∂√üenabh√§ngige Geb√ºhr betr√§gt 0,5% der Bausumme",
    "Zus√§tzliche Pr√ºfungsgeb√ºhren f√ºr Statik: 200-800‚Ç¨",
    "Beispiel: Einfamilienhaus (300.000‚Ç¨) = ca. 1.800‚Ç¨ Gesamtkosten"
  ],
  "citations": [
    {{"text": "Grundgeb√ºhr richtet sich nach Gemeinde", "source_id": 1}},
    {{"text": "0,5% der Bausumme", "source_id": 1}},
    {{"text": "Pr√ºfungsgeb√ºhren f√ºr Statik: 200-800‚Ç¨", "source_id": 2}}
  ],
  "sources": [
    "Geb√ºhrenordnung BauO BW",
    "Kostenrechner Stadt Stuttgart"
  ],
  "tables": [
    {{
      "headers": ["Kommune", "Grundgeb√ºhr", "Gr√∂√üengeb√ºhr", "Beispiel (300k‚Ç¨)"],
      "rows": [
        ["Berlin", "250‚Ç¨", "0.5%", "1.750‚Ç¨"],
        ["M√ºnchen", "350‚Ç¨", "0.5%", "1.850‚Ç¨"],
        ["Stuttgart", "200‚Ç¨", "0.5%", "1.700‚Ç¨"]
      ],
      "caption": "Vergleich Baugenehmigungskosten (Stand 2024)"
    }}
  ],
  "next_steps": "Kontaktieren Sie Ihr zust√§ndiges Bauordnungsamt f√ºr eine genaue Kostensch√§tzung.",
  "follow_ups": [
    "Wann werden die Geb√ºhren f√§llig?",
    "Kann ich die Kosten steuerlich absetzen?",
    "Gibt es Erm√§√üigungen f√ºr Sanierungen?"
  ]
}}

**BEISPIEL 2 (Luftqualit√§t mit Karte + Chart):**

Frage: "Wie ist die Luftqualit√§t in Berlin?"

{{
  "direct_answer": "Die Luftqualit√§t in Berlin ist aktuell gut. Die Messwerte liegen unter den EU-Grenzwerten.",
  "details": [
    "Feinstaub (PM10): 18 Œºg/m¬≥ (Grenzwert: 40 Œºg/m¬≥)",
    "Stickstoffdioxid (NO‚ÇÇ): 22 Œºg/m¬≥ (Grenzwert: 40 Œºg/m¬≥)",
    "Ozon (O‚ÇÉ): 45 Œºg/m¬≥ (Zielwert: 120 Œºg/m¬≥)",
    "Messungen vom Berliner Luftg√ºtemessnetz"
  ],
  "citations": [
    {{"text": "Feinstaub (PM10): 18 Œºg/m¬≥", "source_id": 1}},
    {{"text": "Stickstoffdioxid (NO‚ÇÇ): 22 Œºg/m¬≥", "source_id": 1}},
    {{"text": "EU-Grenzwerte", "source_id": 2}}
  ],
  "sources": [
    "Berliner Luftg√ºtemessnetz - Messdaten 10.10.2024",
    "EU-Luftqualit√§tsrichtlinie 2008/50/EG"
  ],
  "maps": [
    {{
      "center": [52.5200, 13.4050],
      "zoom": 11,
      "markers": [
        {{"lat": 52.5200, "lon": 13.4050, "label": "Alexanderplatz", "popup": "PM10: 18 Œºg/m¬≥"}},
        {{"lat": 52.5065, "lon": 13.2846, "label": "Charlottenburg", "popup": "PM10: 15 Œºg/m¬≥"}},
        {{"lat": 52.4545, "lon": 13.5265, "label": "Neuk√∂lln", "popup": "PM10: 22 Œºg/m¬≥"}}
      ]
    }}
  ],
  "charts": [
    {{
      "chart_type": "bar",
      "data": {{
        "labels": ["PM10", "NO‚ÇÇ", "O‚ÇÉ"],
        "datasets": [
          {{
            "label": "Aktuell (Œºg/m¬≥)",
            "data": [18, 22, 45],
            "backgroundColor": "rgba(75, 192, 192, 0.6)"
          }},
          {{
            "label": "Grenzwert (Œºg/m¬≥)",
            "data": [40, 40, 120],
            "backgroundColor": "rgba(255, 99, 132, 0.6)"
          }}
        ]
      }},
      "title": "Luftqualit√§t Berlin - Vergleich mit Grenzwerten"
    }}
  ],
  "follow_ups": [
    "Welche Messstationen gibt es in meiner N√§he?",
    "Wie hat sich die Luftqualit√§t in den letzten Jahren entwickelt?",
    "Was kann ich pers√∂nlich f√ºr bessere Luft tun?"
  ]
}}

**BEISPIEL 3 (Bauantrag mit Image + Document):**

Frage: "Welche Unterlagen brauche ich f√ºr einen Bauantrag?"

{{
  "direct_answer": "F√ºr einen Bauantrag ben√∂tigen Sie das amtliche Formular, Bauzeichnungen, Lageplan und statische Berechnungen.",
  "details": [
    "Amtlicher Bauantrag (Formular Ihrer Kommune)",
    "Lageplan mit Grundst√ºcksgrenzen (M 1:500)",
    "Bauzeichnungen (Grundrisse, Schnitte, Ansichten)",
    "Statische Berechnungen von qualifiziertem Ingenieur",
    "Baubeschreibung mit Materialangaben"
  ],
  "citations": [
    {{"text": "Amtlicher Bauantrag", "source_id": 1}},
    {{"text": "Lageplan mit Grundst√ºcksgrenzen", "source_id": 1}},
    {{"text": "Statische Berechnungen von qualifiziertem Ingenieur", "source_id": 2}}
  ],
  "sources": [
    "Bauordnungsamt Brandenburg - Checkliste Bauantrag",
    "LBO BW ¬ß 58 - Erforderliche Unterlagen"
  ],
  "images": [
    {{
      "url": "/media/bauantrag_beispiel_grundriss.png",
      "caption": "Beispiel: Grundriss f√ºr Bauantrag (Einfamilienhaus)",
      "alt_text": "Technische Zeichnung Grundriss Erdgeschoss",
      "source_id": 1
    }}
  ],
  "documents": [
    {{
      "url": "/downloads/bauantrag_formular_brandenburg.pdf",
      "filename": "Bauantrag-Formular-Brandenburg.pdf",
      "file_type": "pdf",
      "size": 245000,
      "description": "Amtliches Bauantragsformular Brandenburg (Stand 2024)"
    }},
    {{
      "url": "/downloads/checkliste_bauunterlagen.pdf",
      "filename": "Checkliste-Bauunterlagen.pdf",
      "file_type": "pdf",
      "description": "Vollst√§ndige Checkliste aller erforderlichen Unterlagen"
    }}
  ],
  "next_steps": "Laden Sie die Formulare herunter und wenden Sie sich f√ºr Beratung an Ihr zust√§ndiges Bauordnungsamt.",
  "follow_ups": [
    "Wie lange dauert die Bearbeitung meines Bauantrags?",
    "Was kostet die Baugenehmigung?",
    "Kann ich den Bauantrag digital einreichen?"
  ]
}}

**Jetzt beantworte die User-Frage im GLEICHEN JSON-FORMAT (mit Rich Media wenn sinnvoll!):**
"""
    }


# ============================================================================
# FRONTEND RENDERER (Conceptual)
# ============================================================================

def render_rich_media_response(json_response: Dict[str, Any]) -> str:
    """
    Conceptual: Wie Frontend Rich Media rendern w√ºrde
    
    Returns:
        HTML/Markdown string with embedded rich media
    """
    output = []
    
    # Direct Answer
    output.append(f"**Direkte Antwort:**\n{json_response['direct_answer']}\n")
    
    # Details
    if json_response.get('details'):
        output.append("**Details:**\n")
        for detail in json_response['details']:
            output.append(f"‚Ä¢ {detail}")
        output.append("")
    
    # Images
    if json_response.get('images'):
        output.append("**üì∏ Bilder:**\n")
        for img in json_response['images']:
            output.append(f"![{img.get('alt_text', 'Image')}]({img['url']})")
            if img.get('caption'):
                output.append(f"*{img['caption']}*")
        output.append("")
    
    # Maps
    if json_response.get('maps'):
        output.append("**üó∫Ô∏è Karte:**\n")
        for map_data in json_response['maps']:
            output.append(f"<div class='map' data-center='{map_data['center']}' data-zoom='{map_data['zoom']}'></div>")
        output.append("")
    
    # Charts
    if json_response.get('charts'):
        output.append("**üìä Diagramme:**\n")
        for chart in json_response['charts']:
            output.append(f"<canvas id='chart-{chart.get('title', 'data')}' data-config='{json.dumps(chart['data'])}'></canvas>")
        output.append("")
    
    # Tables
    if json_response.get('tables'):
        for table in json_response['tables']:
            if table.get('caption'):
                output.append(f"**{table['caption']}**\n")
            
            # Markdown table
            output.append("| " + " | ".join(table['headers']) + " |")
            output.append("| " + " | ".join(["---"] * len(table['headers'])) + " |")
            for row in table['rows']:
                output.append("| " + " | ".join(str(cell) for cell in row) + " |")
            output.append("")
    
    # Sources
    if json_response.get('sources'):
        output.append("**Quellen:**")
        for i, source in enumerate(json_response['sources'], 1):
            output.append(f"[{i}] {source}")
        output.append("")
    
    # Follow-ups
    if json_response.get('follow_ups'):
        output.append("**üí° Vorschl√§ge:**")
        for q in json_response['follow_ups']:
            output.append(f"‚Ä¢ {q}")
    
    return "\n".join(output)


if __name__ == "__main__":
    print("="*80)
    print("üé® RICH MEDIA JSON SCHEMA")
    print("="*80)
    print("\nSchema Preview:")
    print(json.dumps(RICH_MEDIA_SCHEMA, indent=2))
    
    print("\n" + "="*80)
    print("üìã Supported Media Types:")
    print("="*80)
    print("üñºÔ∏è  Images - URLs, Captions, Alt-Text")
    print("üó∫Ô∏è  Maps - GeoJSON, Markers, Interactive")
    print("üìä Charts - Bar, Line, Pie, Scatter")
    print("üìã Tables - Structured Data with Headers")
    print("üé• Videos - YouTube, Vimeo, Local")
    print("üìÑ Documents - PDFs, Downloads, Previews")
